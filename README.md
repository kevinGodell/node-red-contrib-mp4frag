# node-red-contrib-mp4frag
######
[![GitHub license](https://img.shields.io/badge/license-MIT-brightgreen.svg)](https://raw.githubusercontent.com/kevinGodell/node-red-contrib-mp4frag/master/LICENSE?token=ABOPHYQ73XPHMEGBSABCDJK7IKRQO)
[![npm](https://img.shields.io/npm/dt/node-red-contrib-mp4frag.svg?style=flat-square)](https://www.npmjs.com/package/node-red-contrib-mp4frag)
[![GitHub issues](https://img.shields.io/github/issues/kevinGodell/node-red-contrib-mp4frag.svg)](https://github.com/kevinGodell/node-red-contrib-mp4frag/issues)
#### What?
- A node-red wrapper for mp4frag.
#### Why?
- Needed for extracting a fragmented mp4 from a buffer stream.
#### How?
- Parses the fragments (initialization and segments) of the mp4.
#### When?
- Using ffmpeg to connect to a video source and piping out a fragmented mp4.
#### Where?
- mp4frag instance will be accessible in the global context.
- `const mp4frag = global.get('unique_name');`
#### Requirements
- Input must be a buffer stream containing a properly fragmented mp4.
- ffmpeg flags: `-f mp4 -movflags +frag_keyframe+empty_moov+default_base_moof`.
#### Links
- [node-red](https://nodered.org/)
- [ffmpeg](https://ffmpeg.org/)
- [buffer](https://nodejs.org/api/buffer.html)
- [mp4frag](https://www.npmjs.com/package/mp4frag)
#### Installation
```
npm install kevinGodell/node-red-contrib-mp4frag
```
#### Flow Example
```json
[{"id":"26b5a4eb.db1d34","type":"tab","label":"Flow 1","disabled":false,"info":""},{"id":"95acc154.09f0c","type":"inject","z":"26b5a4eb.db1d34","name":"Start stream","props":[{"p":"payload"}],"repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"","payload":"true","payloadType":"str","x":110,"y":40,"wires":[["7dbc80c7.4e764"]]},{"id":"8b7657be.b17558","type":"inject","z":"26b5a4eb.db1d34","name":"Stop stream","props":[{"p":"payload"}],"repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"","payload":"false","payloadType":"str","x":110,"y":86,"wires":[["7dbc80c7.4e764"]]},{"id":"7dbc80c7.4e764","type":"switch","z":"26b5a4eb.db1d34","name":"","property":"payload","propertyType":"msg","rules":[{"t":"eq","v":"true","vt":"str"},{"t":"eq","v":"false","vt":"str"}],"checkall":"true","repair":false,"outputs":2,"x":261,"y":40,"wires":[["70626fe2.0e9c5"],["fd61d017.59965"]]},{"id":"fd61d017.59965","type":"function","z":"26b5a4eb.db1d34","name":"stop","func":"msg= [\n    {\n    kill:'SIGHUP',\n    payload : 'SIGHUP'\n    }\n    \n    \n    ];     // set a new payload & the counter\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","x":281,"y":89,"wires":[["70626fe2.0e9c5"]]},{"id":"70626fe2.0e9c5","type":"exec","z":"26b5a4eb.db1d34","command":"ffmpeg -loglevel quiet -hwaccel rpi -c:v h264_mmal -rtsp_transport tcp -i  rtsp://192.168.1.4:554/user=admin_password=pass_channel=0_stream=1.sdp?real_stream -q 2 -vf fps=fps=2,scale=-1:-1 -c:v mjpeg -f image2pipe pipe:2 -an -c:v copy -f mp4 -movflags +frag_keyframe+empty_moov+default_base_moof pipe:1","addpay":false,"append":"","useSpawn":"true","timer":"","oldrc":false,"name":"rtsp to jpeg","x":434,"y":49,"wires":[["5b6efe14.44e2b"],["752eb.8f4e1d158"],["de5055b3.670538"]]},{"id":"522ad11.3d8643","type":"image","z":"26b5a4eb.db1d34","name":"","width":"320","data":"payload","dataType":"msg","thumbnail":false,"active":true,"pass":false,"outputs":0,"x":180,"y":240,"wires":[]},{"id":"752eb.8f4e1d158","type":"pipe2jpeg","z":"26b5a4eb.db1d34","name":"some name","x":620,"y":100,"wires":[["522ad11.3d8643"]]},{"id":"f94373f8.d3d9b","type":"http in","z":"26b5a4eb.db1d34","name":"","url":":base([a-z_]+).m3u8","method":"get","upload":false,"swaggerDoc":"","x":521,"y":196,"wires":[["575c6379.bf74dc"]]},{"id":"d360f454.75f2b8","type":"http in","z":"26b5a4eb.db1d34","name":"","url":"init-:base([a-z_]+).mp4","method":"get","upload":false,"swaggerDoc":"","x":531,"y":236,"wires":[["ccdad96e.857a08"]]},{"id":"bc4e092d.1ee938","type":"http in","z":"26b5a4eb.db1d34","name":"","url":":base([a-z_]+):seq(\\d+).m4s","method":"get","upload":false,"swaggerDoc":"","x":541,"y":276,"wires":[["39c27647.a5d5ca"]]},{"id":"be9c49a3.a66a78","type":"http in","z":"26b5a4eb.db1d34","name":"","url":":base([a-z_]+).m3u8.txt","method":"get","upload":false,"swaggerDoc":"","x":531,"y":316,"wires":[["3827e276.b31f8e"]]},{"id":"3827e276.b31f8e","type":"function","z":"26b5a4eb.db1d34","name":"mp4frag context","func":"const { base } = msg.req.params;\n\nconst mp4frag = global.get(base);\n\nconst m3u8 = mp4frag && mp4frag.m3u8;\n\nif (m3u8) {\n    msg.payload = m3u8;\n    msg.headers = {'content-type': 'text/plain'};\n} else {\n    msg.payload = 'm3u8 playlist not found';\n    msg.headers = {'content-type': 'text/plain'};\n    msg.statusCode = 404;\n}\n\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","x":791,"y":316,"wires":[["228a5549.40f13a"]]},{"id":"228a5549.40f13a","type":"http response","z":"26b5a4eb.db1d34","name":"","statusCode":"","headers":{},"x":961,"y":316,"wires":[]},{"id":"39c27647.a5d5ca","type":"function","z":"26b5a4eb.db1d34","name":"mp4frag context","func":"const { base, seq } = msg.req.params;\n\nconst mp4frag = global.get(base);\n\nconst segment = mp4frag && mp4frag.getHlsSegment(seq);\n\nif (segment) {\n    msg.payload = segment;\n    msg.headers = {'content-type': 'video/mp4'};\n} else {\n    msg.payload = `segment ${sequence} not found`;\n    msg.headers = {'content-type': 'text/plain'};\n    msg.statusCode = 404;\n}\n\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","x":790,"y":276,"wires":[["4231b8b3.b0fa68"]]},{"id":"4231b8b3.b0fa68","type":"http response","z":"26b5a4eb.db1d34","name":"","statusCode":"","headers":{},"x":961,"y":276,"wires":[]},{"id":"ccdad96e.857a08","type":"function","z":"26b5a4eb.db1d34","name":"mp4frag context","func":"const { base } = msg.req.params;\n\nconst mp4frag = global.get(base);\n\nconst initialization = mp4frag && mp4frag.initialization;\n\nif (initialization) {\n    msg.payload = initialization;\n    msg.headers = {'content-type': 'video/mp4'};\n} else {\n    msg.payload = 'initialization fragment not found';\n    msg.headers = {'content-type': 'text/plain'};\n    msg.statusCode = 404;\n}\n\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","x":788,"y":236,"wires":[["270da754.a5f5e8"]]},{"id":"270da754.a5f5e8","type":"http response","z":"26b5a4eb.db1d34","name":"","statusCode":"","headers":{},"x":961,"y":236,"wires":[]},{"id":"575c6379.bf74dc","type":"function","z":"26b5a4eb.db1d34","name":"mp4frag context","func":"const { base } = msg.req.params;\n\nconst mp4frag = global.get(base);\n\nconst m3u8 = mp4frag && mp4frag.m3u8;\n\nif (m3u8) {\n    msg.payload = m3u8;\n    msg.headers = {'content-type': 'application/vnd.apple.mpegURL'};\n    //msg.headers = {'content-type': 'application/x-mpegURL'};\n    //msg.headers = {'content-type': 'application/x-mpegurl'};\n} else {\n    msg.payload = 'm3u8 playlist not found';\n    msg.headers = {'content-type': 'text/plain'};\n    msg.statusCode = 404;\n}\n\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","x":787,"y":196,"wires":[["5e29cec.60df53"]]},{"id":"5e29cec.60df53","type":"http response","z":"26b5a4eb.db1d34","name":"","statusCode":"","headers":{},"x":961,"y":196,"wires":[]},{"id":"5b6efe14.44e2b","type":"mp4frag","z":"26b5a4eb.db1d34","hlsBase":"some_name","hlsListSize":4,"x":608,"y":40,"wires":[]},{"id":"7d7f3048.697ca","type":"ui_template","z":"26b5a4eb.db1d34","group":"ea204528.5e15d8","name":"hls.js","order":3,"width":0,"height":0,"format":"<script src=\"https://cdnjs.cloudflare.com/ajax/libs/hls.js/0.14.11-0.alpha.5846/hls.min.js\"></script>","storeOutMessages":true,"fwdInMessages":true,"resendOnRefresh":true,"templateScope":"global","x":950,"y":40,"wires":[[]]},{"id":"6563fe87.7ee38","type":"ui_template","z":"26b5a4eb.db1d34","group":"ea204528.5e15d8","name":"video player","order":4,"width":"0","height":"0","format":"<video id=\"video\" muted></video>\n<script>\n  var video = document.getElementById('video');\n  var videoSrc = 'http://192.168.1.85:1880/some_name.m3u8';\n  //\n  // First check for native browser HLS support\n  //\n  if (video.canPlayType('application/vnd.apple.mpegurl')) {\n    video.src = videoSrc;\n    video.addEventListener('loadedmetadata', function() {\n      video.play();\n    });\n  //\n  // If no native HLS support, check if hls.js is supported\n  //\n  } else if (Hls.isSupported()) {\n    var hls = new Hls();\n    hls.loadSource(videoSrc);\n    hls.attachMedia(video);\n    hls.on(Hls.Events.MANIFEST_PARSED, function() {\n      video.play();\n    });\n  }\n</script>\n","storeOutMessages":true,"fwdInMessages":true,"resendOnRefresh":true,"templateScope":"local","x":790,"y":40,"wires":[[]]},{"id":"de5055b3.670538","type":"debug","z":"26b5a4eb.db1d34","name":"","active":true,"tosidebar":true,"console":true,"tostatus":true,"complete":"payload","targetType":"msg","statusVal":"payload","statusType":"auto","x":180,"y":160,"wires":[]},{"id":"ea204528.5e15d8","type":"ui_group","name":"Group 1","tab":"ef1a3eec.2694d","order":1,"disp":true,"width":6},{"id":"ef1a3eec.2694d","type":"ui_tab","z":"26b5a4eb.db1d34","name":"Dashboard","icon":"dashboard","order":1,"disabled":false,"hidden":false}]
```
#### Screenshots
![screen shot 1](screenshot1.png)
