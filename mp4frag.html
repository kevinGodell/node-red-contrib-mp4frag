<script type="text/javascript">
  /*
   globally scoped vars and funcs in admin screen?
   or is scoped to only our nodes?
   */

  // define magic numbers
  const MAGIC = {
    hlsListSizeDef: 4,
    hlsListSizeMin: 2,
    hlsListSizeMax: 10,
    hlsListExtraDef: 0,
    hlsListExtraMin: 0,
    hlsListExtraMax: 5,
  };

  // regex to match hlsListUrl allowed characters
  const hlsListUrlRegex = RED.validators.regex(/^[a-z0-9_.]{1,50}$/i);

  // check if other node already using unique value
  const uniqueValInUse = obj => {
    let exists = false;
    RED.nodes.eachNode(function (node) {
      if (node.id !== obj.id && node.type === obj.type && node[obj.name] === obj.value) {
        exists = true;
      }
    });
    return exists;
  };

  /*
    register node
   */

  RED.nodes.registerType('mp4frag', {
    align: 'left',
    category: 'cctv',
    color: '#DEBD5C',
    defaults: {
      name: {
        value: '',
      },
      hlsListSize: {
        value: MAGIC.hlsListSizeDef,
        required: true,
        validate: function (hlsListSize) {
          return hlsListSize >= MAGIC.hlsListSizeMin && hlsListSize <= MAGIC.hlsListSizeMax;
        },
      },
      hlsListExtra: {
        value: MAGIC.hlsListExtraDef,
        required: true,
        validate: function (hlsListExtra) {
          return hlsListExtra >= MAGIC.hlsListExtraMin && hlsListExtra <= MAGIC.hlsListExtraMax;
        },
      },
      hlsListUrl: {
        value: '',
        required: true,
        validate: function (hlsListUrl) {
          return (
            hlsListUrlRegex(hlsListUrl) === true &&
            uniqueValInUse({ id: this.id, type: this.type, name: 'hlsListUrl', value: hlsListUrl }) === false
          );
        },
      },
    },
    icon: 'font-awesome/fa-file-video-o',
    inputLabels: 'buffer',
    inputs: 1,
    label: function () {
      if (this.name) {
        return this.name;
      }
      if (this.valid === false && this.validationErrors.includes('hlsListUrl')) {
        return `/mp4frag/${this.id}/hls.m3u8`;
      }
      return `/mp4frag/${this.hlsListUrl}/hls.m3u8`;
    },
    outputLabels: 'status',
    outputs: 1,
    oneditprepare: function () {
      $('#node-input-hlsListSize').typedInput({
        types: [
          {
            value: 'num',
            label: 'HLS List Size',
            icon: 'fa fa-list-ol',
            options: ['2', '3', '4', '5', '6', '7', '8', '9', '10'],
          },
        ],
      });

      $('#node-input-hlsListExtra').typedInput({
        types: [
          {
            value: 'num',
            label: 'HLS List Extra',
            icon: 'fa fa-list-ol',
            options: ['0', '1', '2', '3', '4', '5'],
          },
        ],
      });

      const hlsListUrl = $('#node-input-hlsListUrl')
        .attr({
          placeholder: this.id,
        })
        .on('input', function () {
          const newVal = this.value.replace(/[^a-z0-9_.]/gi, '');
          if (this.value !== newVal) {
            this.value = newVal;
          }
        });

      if (hlsListUrl.val() === '') {
        hlsListUrl.val(this.id);
      }
    },
    oneditsave: function () {},
  });
</script>

<script data-template-name="mp4frag" type="text/html">
  <div class="form-row">
    <label for="node-input-name"><i class="fa fa-tag"></i> Name</label>
    <input type="text" id="node-input-name" placeholder="Name" />
  </div>

  <fieldset>
    <legend>HLS List Options</legend>

    <div class="form-row">
      <label for="node-input-hlsListSize"><i class="fa fa-list-ol"></i> Size</label>
      <input id="node-input-hlsListSize" />
    </div>

    <div class="form-row">
      <label for="node-input-hlsListExtra"><i class="fa fa-list-ol"></i> Extra</label>
      <input id="node-input-hlsListExtra" />
    </div>

    <div class="form-row">
      <label for="node-input-hlsListUrl"><i class="fa fa-globe"></i> URL</label>
      <code>/mp4frag/<input style="width:auto;text-align:center" type="text" id="node-input-hlsListUrl" />/hls.m3u8</code>
    </div>
  </fieldset>
</script>

<script data-help-name="mp4frag" type="text/html">
  <p>Parse and serve a fragmented mp4 from a buffer.</p>
</script>
