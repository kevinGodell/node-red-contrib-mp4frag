<script type="text/javascript">
  /*
   helper functions for validations
   first try to grab values from elem (validation cycle)
   grab values from node if elem not found (page load)
   */
  const hlsListSize = () => {
    const hlsListSizeElem = $('#node-input-hlsListSize');
    return hlsListSizeElem.length ? hlsListSizeElem.val() : node.hlsListSize;
  };

  const uniqueName = () => {
    const uniqueNameElem = $('#node-input-uniqueName');
    return uniqueNameElem.length ? uniqueNameElem.val() : node.uniqueName;
  };

  const contextAccess = () => {
    const contextAccessElem = $('#node-input-contextAccess');
    return contextAccessElem.length ? contextAccessElem.val() : node.contextAccess;
  };

  const httpRoutes = () => {
    const httpRoutesElem = $('#node-input-httpRoutes');
    return httpRoutesElem.length ? httpRoutesElem.is(':checked') : node.httpRoutes;
  };

  const routesStructure = () => {
    const routesStructureElem = $('#node-input-routesStructure');
    return routesStructureElem.length ? routesStructureElem.val() : node.routesStructure;
  };

  const updatePlaylist = str => {
    const playlist = $('#playlist');
    if (playlist.length) {
      playlist.text(str);
    }
  };

  const httpRoutesToggle = bool => {
    const routesStructure = $('#routesStructure');
    //const playlistTip = $('#playlistTip');
    if (bool === true) {
      routesStructure.show();
      //playlistTip.show();
    } else {
      routesStructure.hide();
      //playlistTip.hide();
    }
  };

  RED.nodes.registerType('mp4frag', {
    align: 'left',
    category: 'cctv',
    color: '#DEBD5C',
    defaults: {
      name: {
        value: '',
        required: false,
      },
      hlsListSize: {
        value: 4,
        required: true,
        validate: function (hlsListSize) {
          return hlsListSize >= 2 && hlsListSize <= 10;
        },
      },
      uniqueName: {
        value: '',
        required: false,
        validate: function (uniqueName) {
          return (
            (contextAccess() === 'none' && (httpRoutes() === false || routesStructure() === 'id_path')) ||
            RED.validators.regex(/^(?:(?!^Change_This_Name$)[a-z_]){3,50}$/i)(uniqueName)
          );
        },
      },
      contextAccess: {
        value: 'none',
        required: true,
        validate: function (contextAccess) {
          return ['none', 'flow', 'global'].includes(contextAccess);
        },
      },
      httpRoutes: {
        value: true,
        required: true,
        validate: function (/*checkbox does not return if checked*/) {
          const httpRoutesBool = httpRoutes();
          httpRoutesToggle(httpRoutesBool);
          return typeof httpRoutesBool === 'boolean';
        },
      },
      routesStructure: {
        value: 'id_path',
        required: false,
        validate: function (routesStructure) {
          let url;
          const uniqueNameStr = uniqueName();
          if (routesStructure === 'id_path') {
            url = `/mp4frag/${this.id}/hls.m3u8`;
          } else if (
            routesStructure === 'unique_path' &&
            RED.validators.regex(/^(?:(?!^Change_This_Name$)[a-z_]){3,50}$/i)(uniqueNameStr)
          ) {
            url = `/mp4frag/${uniqueNameStr}/hls.m3u8`;
          } else {
            url = 'invalid data';
          }
          updatePlaylist(url);
          return ['unique_path', 'id_path'].includes(routesStructure);
        },
      },
    },
    icon: 'font-awesome/fa-file-video-o',
    inputLabels: 'buffer',
    inputs: 1,
    label: function () {
      return this.name || this.uniqueName || 'mp4frag';
    },
    outputLabels: 'status',
    outputs: 1,
    oneditprepare: function () {},
  });
</script>

<script data-template-name="mp4frag" type="text/html">
  <div class="form-row">
    <label style="width:9rem;" for="node-input-name"><i class="fa fa-tag"></i> Name</label>
    <input style="width:auto;min-width:15rem" type="text" id="node-input-name" placeholder="Name" />
  </div>

  <div class="form-row">
    <label style="width:9rem" for="node-input-hlsListSize"><i class="fa fa-list-ol"></i> HLS List Size</label>
    <input
      style="width:auto;min-width:15rem"
      type="number"
      id="node-input-hlsListSize"
      placeholder="4"
      min="2"
      max="10"
    />
  </div>

  <div class="form-row">
    <label style="width:9rem;" for="node-input-uniqueName"><i class="fa fa-barcode"></i> Unique Name</label>
    <input
      style="width:auto;min-width:15rem"
      type="text"
      id="node-input-uniqueName"
      placeholder="Letters_And_Underscores_Only"
    />
  </div>

  <div class="form-row">
    <label style="width:9rem" for="node-input-contextAccess"><i class="fa fa-database"></i> Context Access</label>
    <select style="width:auto;min-width:15rem" id="node-input-contextAccess">
      <option value="none">none</option>
      <option value="flow">flow</option>
      <option value="global">global</option>
    </select>
  </div>

  <div class="form-row">
    <label style="width:9rem" for="node-input-httpRoutes"><i class="fa fa-globe"></i> HTTP Routes</label>
    <input style="width:auto" type="checkbox" id="node-input-httpRoutes" value="some" />
  </div>

  <div class="form-row" id="routesStructure">
    <label style="width:9rem" for="node-input-routesStructure"><i class="fa fa-globe"></i> Routes Structure</label>
    <select style="width:auto;min-width:15rem" id="node-input-routesStructure">
      <option value="id_path" id="idPath">/mp4frag/{nodeID}/hls.m3u8</option>
      <option value="unique_path" id="uniquePath">/mp4frag/{uniqueName}/hls.m3u8</option>
    </select>
    <div class="form-tips" style="margin-top:5px">
      <code style="display:block;text-align:center" id="playlist"></code>
    </div>
  </div>
</script>

<script data-help-name="mp4frag" type="text/html">
  <p>Parse a fragmented mp4 from a buffer.</p>
</script>
